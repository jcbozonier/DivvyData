<html>
<head>
  <title>DivvyFucked</title>
  <script src="./jquery.js"></script>
  <script>
    var to_radians = function(number){
      return number * Math.PI / 180;
    };
    var haversineDistance = function(pointA, pointB){
      var lat1 = pointA.latitude;
      var lon1 = pointA.longitude;
      var lat2 = pointB.latitude;
      var lon2 = pointB.longitude;
      var R = 3959;
      // In miles
      var dLat = to_radians(lat2 - lat1);
      var dLon = to_radians(lon2 - lon1);
      lat1 = to_radians(lat1);
      lat2 = to_radians(lat2);

      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
      var c = 2 * Math.asin(Math.sqrt(a));
      return R * c;
    };

    /*var euclideanDistance = function(pointA, pointB){
      return Math.sqrt(Math.pow(pointB.latitude - pointA.latitude, 2) + Math.pow(pointB.longitude - pointA.longitude, 2))
    };*/

  
     var taxiDistance = function(pointA, pointB){
      return (
        haversine({'latitude':pointA.latitude  ,'longitude':pointA.longitude},
        {'latitude':pointA.latitude  ,'longitude':pointB.longitude}) +
        haversine({'latitude':pointA.latitude  ,'longitude':pointB.longitude},
        {'latitude':pointB.latitude  ,'longitude':pointB.longitude})
        )
    }; 
    

    var compromiseDistance = function(pointA, pointB){
      return (haversineDistance(pointA, pointB) + taxiDistance(pointA, pointB))/2
    };

    var relativeLocation = function(anchorLocation, otherPoint){
      return {
        'latitude': otherPoint.latitude - anchorLocation.latitude,
        'longitude': otherPoint.longitude - anchorLocation.longitude
      };
    };

    var find_direction = function(current_location, station){
      var updated_location = relativeLocation(current_location, station);
      var horizontal_direction = updated_location.longitude > 0 ? 'east' : 'west';
      var vertical_direction = updated_location.latitude < 0 ? 'south' : 'north';
      return vertical_direction + horizontal_direction;
    };

    var LoadLocation = function(fn){
      navigator.geolocation.getCurrentPosition(function(location){
        fn({'latitude': location.coords.latitude, 'longitude':location.coords.longitude});
      },
      function(err){
        var a=err;
      });
    };
    var LoadStations = function(current_location){
      var grid = {
        'northeast':[],
        'northwest':[],
        'southeast':[],
        'southwest':[]
      };

      $('#output #status').empty();

      $('#output #status').append("Current location: " + current_location.latitude + ', ' + current_location.longitude);
      $.getJSON('http://anyorigin.com/get?url=http%3A//divvybikes.com/stations/json&callback=?', function(data)
      {
        divvy_data = data.contents;
        for(var index in divvy_data.stationBeanList){
          var station = divvy_data.stationBeanList[index];
          var distance = compromiseDistance(current_location, station);
          var station_direction = find_direction(current_location, station);
          grid[station_direction].push({
            'name': station.stationName,
            'direction': station_direction,
            'distance': Math.floor(100*distance,0)/100,
            'bikesAvailable': station.availableBikes > 0,
            'spaceAvailable': station.availableDocks > 0,
          });
          //$('#output ul').append("<li>Name: " + station.stationName + "; Distance: " + distance + "<br />(" + station_direction + ")</li>");
        }
        for(var index_to_clear in grid){
          $('#' + index_to_clear).empty();
        }

        for(var direction_index in grid){
          grid[direction_index].sort(function(a,b){
            return a.distance - b.distance;
          });
          for(var station_index in grid[direction_index]){
            var station = grid[direction_index][station_index];
            if(station.bikesAvailable && station.spaceAvailable){
              $("#"+station.direction).append("<li style='color:black;'>+ " + station.distance + " " + station.name + "</li>");
              continue;
            }
            if(station.bikesAvailable){
              $("#"+station.direction).append("<li style='color:green;'>|||" + station.distance + " " + station.name + "</li>");
            }
            if(station.spaceAvailable){
              $("#"+station.direction).append("<li style='color:blue;'>_&nbsp;" + station.distance + " " + station.name + "</li>")
            }
          }
        }

      });
    };
    
    LoadLocation(function(location){
      LoadStations(location);
      window.setInterval(function(){
        LoadStations(location);
      }, 60000);
    });
    //LoadStations();

  </script>
  <style type='text/css'>
    body{
      font-family: arial;
      font-size:12pt;
    }
    ul{
      list-style-type: none;
    }
  </style>
</head>
<body>
  <h1>Don't be DivvyFucked!</h1>
  <div id="output">
    <span id="status"></span>
    <h3>Northwest</h3>
    <ul id='northwest'></ul>
    <h3>Southwest</h3>
    <ul id='southwest'></ul>
    <h3>Northeast</h3>
    <ul id='northeast'></ul>
    <h3>Southeast</h3>
    <ul id='southeast'></ul>
  </div>
</body>
</html>
